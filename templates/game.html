{% extends "base.html" %}
{% block content %}

<style>
  .game-grid{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:16px;
    align-items:start;
  }
  @media (max-width: 900px){
    .game-grid{ grid-template-columns: 1fr; }
  }

  .pill{
    display:inline-block;
    padding:2px 8px;
    border-radius:999px;
    font-size:12px;
    background:rgba(255,255,255,0.08);
  }
  .small{ font-size: 12px; }
  .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

  .delta.up   { color: #30d158; font-weight: 700; }
  .delta.down { color: #ff453a; font-weight: 700; }
  .delta.same { color: inherit; opacity: 0.9; }

  .rotate-hint{
    display:none;
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.82);
    color:#fff;
    z-index:9999;
    padding:24px;
    text-align:center;
  }
  .rotate-hint .box{
    max-width:520px;
    margin:12vh auto 0;
    padding:18px;
    border-radius:14px;
    background:rgba(255,255,255,0.08);
  }
  .rotate-hint .box h3{ margin:0 0 10px 0; }
  .rotate-hint .box p{ margin:0; opacity:0.95; }
  .rotate-hint .box button{
    margin-top:14px;
    padding:10px 14px;
    border-radius:10px;
    border:0;
    cursor:pointer;
  }
  @keyframes flashUp {
    0%   { background: rgba(48, 209, 88, 0.28); }
    100% { background: transparent; }
  }
  @keyframes flashDown {
    0%   { background: rgba(255, 69, 58, 0.26); }
    100% { background: transparent; }
  }
  tr.flash-up   { animation: flashUp 1.2s ease-out 1; }
  tr.flash-down { animation: flashDown 1.2s ease-out 1; }
</style>

<!-- Optional landscape hint -->
<div class="rotate-hint" id="rotateHint">
  <div class="box">
    <h3>Rotate to landscape</h3>
    <p>For the best view (Guess + Standings side-by-side), rotate your device.</p>
    <button onclick="document.getElementById('rotateHint').style.dis='none'">Continue anyway</button>
  </div>
</div>

<div class="game-grid">

  <!-- LEFT: Guess -->
  <div class="card">
    <h2>Play</h2>
    <p class="muted">
      Player: <strong>{{ player.name }}</strong>
      ¬∑ Difficulty: <strong>{{ difficulty }}</strong>
      ¬∑ <span class="pill" id="statePill">live</span>
    </p>

    {% if request.args.get("err") == "enter_one" %}
      <p class="err">Please enter at least one field (song, artist, or year).</p>
    {% endif %}

    {% if status == "ended" %}
      <p class="err">
        Game finished{% if ended_at %} ({{ ended_at }}){% endif %}. Final standings are shown on the right.
      </p>
    {% endif %}

    {% if request.args.get("msg") == "ended" %}
      <p class="err">Game is finished. Submissions are locked.</p>
    {% endif %}

    {% if status != "ended" and open_round %}
      <h3>Open round <span class="pill" id="roundPill">#{{ open_round.id }}</span></h3>
      <p id="roundQuestion"><strong>#{{ open_round.id }}</strong> {{ open_round.question or "" }}</p>
      <p class="muted small" id="submitStatus">
        {% if my_guess %}Submitted ‚úÖ (you can still edit){% else %}Not submitted yet{% endif %}
      </p>

      <form method="post" action="{{ url_for('submit') }}">
        <label>Song</label>
        <input name="guess_song" value="{{ my_guess.guess_song if my_guess else '' }}" placeholder="Your guess">

        <label>Artist</label>
        <input name="guess_artist" value="{{ my_guess.guess_artist if my_guess else '' }}" placeholder="Your guess">

        <label>Year</label>
        <input name="guess_year" value="{{ my_guess.guess_year if my_guess else '' }}" placeholder="e.g. 1976">

        <button class="btn" type="submit">
          {% if my_guess %}Update guess{% else %}Submit guess{% endif %}
        </button>
      </form>
    {% elif status == "ended" %}
      <p class="muted">No more guesses. Enjoy the podium üèÅ</p>
    {% else %}
      <p class="muted">No open round yet. Wait for the admin to start one.</p>
    {% endif %}
  </div>

  <!-- RIGHT: Standings -->
  <div class="card">
    <h2>
      Standings
      <span class="pill" id="standingsPill">auto</span>
    </h2>

    <p class="muted small">
      Updates every <span class="mono">5s</span>.
      Last update: <span class="mono" id="standingsLastUpdate">-</span>
    </p>

    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>Player</th>
          <th>Pts</th>
          <th>Œî</th>
        </tr>
      </thead>
      <tbody id="standingsBody">
        {% for s in standings %}
          <tr>
            <td>{{ s.rank }}</td>
            <td>{{ s.player }}</td>
            <td><strong>{{ s.points }}</strong></td>
            <td>
              {% if s.delta > 0 %}
                <span class="delta up">+{{ s.delta }}</span>
              {% elif s.delta < 0 %}
                <span class="delta down">{{ s.delta }}</span>
              {% else %}
                <span class="delta same">0</span>
              {% endif %}
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

</div>

<!-- BELOW: last round results (optional, full width) -->
{% if last_closed %}
  <div class="card" style="margin-top:16px;">
    <h2>Last round results</h2>
    <p class="muted">
      <strong>#{{ last_closed.id }}</strong> {{ last_closed.question or "" }}
    </p>

    {% if correct %}
      <p>
        <strong>Correct:</strong>
        {{ correct.song }} ¬∑ {{ correct.artist }} ¬∑ {{ correct.year }}
      </p>
    {% endif %}

    <table>
      <thead>
        <tr>
          <th>Player</th>
          <th>Song</th>
          <th>Artist</th>
          <th>Year</th>
          <th>Song P</th>
          <th>Artist P</th>
          <th>Year P</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody>
        {% for r in last_results %}
          <tr>
            <td>{{ r.player }}</td>
            <td>{{ r.guess_song or '' }}</td>
            <td>{{ r.guess_artist or '' }}</td>
            <td>{{ r.guess_year if r.guess_year is not none else '' }}</td>
            <td>{{ r.points_song }}</td>
            <td>{{ r.points_artist }}</td>
            <td>{{ r.points_year }}</td>
            <td><strong>{{ r.total_points }}</strong></td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
{% endif %}

<script>
  // ---- Soft "landscape hint"
  const hint = document.getElementById("rotateHint");
  function updateHint(){
    const portrait = window.matchMedia && window.matchMedia("(orientation: portrait)").matches;
    hint.style.display = portrait ? "block" : "none";
  }
  updateHint();
  window.addEventListener("resize", updateHint);

  const MY_NAME = {{ player.name|tojson }};
  let lastMyPoints = null; // prevents flashing on first load

  // ---- Helpers
  function esc(s){
    return String(s ?? "").replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[m]));
  }

  // ---- Auto-refresh standings
  const standingsBody = document.getElementById("standingsBody");
  const standingsLastUpdate = document.getElementById("standingsLastUpdate");
  const standingsPill = document.getElementById("standingsPill");

  async function refreshStandings(){
    try{
      const res = await fetch("/api/standings?ts=" + Date.now(), { cache: "no-store" });
      if(!res.ok) { standingsPill.textContent = "error"; return; }
      const rows = await res.json(); // [{rank,player,points,delta}]
      const rowsArr = rows || [];
let myNewPoints = null;

const html = rowsArr.map(r => {
  const playerName = String(r.player || "");
  const points = Number(r.points || 0);

  // detect my row
  const isMe = playerName.trim().toLowerCase() === String(MY_NAME).trim().toLowerCase();
  if (isMe) myNewPoints = points;

  // delta coloring already exists
  const d = Number(r.delta || 0);
  let deltaHtml = `<span class="delta same">0</span>`;
  if(d > 0) deltaHtml = `<span class="delta up">+${d}</span>`;
  if(d < 0) deltaHtml = `<span class="delta down">${d}</span>`;

  // flash only my row when points changed
  let flashClass = "";
  if (isMe && lastMyPoints !== null && myNewPoints !== null && myNewPoints !== lastMyPoints) {
    flashClass = (myNewPoints > lastMyPoints) ? "flash-up" : "flash-down";
  }

  return `
    <tr class="${flashClass}">
      <td>${esc(r.rank)}</td>
      <td>${esc(playerName)}</td>
      <td><strong>${esc(points)}</strong></td>
      <td>${deltaHtml}</td>
    </tr>
  `;
}).join("");

standingsBody.innerHTML = html || `<tr><td colspan="4" class="muted">No players yet.</td></tr>`;

// update last points AFTER rendering
if (myNewPoints !== null) lastMyPoints = myNewPoints;

standingsLastUpdate.textContent = new Date().toLocaleTimeString();
standingsPill.textContent = "auto";

    }catch(e){
      standingsPill.textContent = "offline";
    }
  }

  refreshStandings();
  setInterval(refreshStandings, 5000);

  // ---- Auto-detect new round open/close
  // If round id changes, reload the page so the form updates safely.
  let currentRoundId = {{ open_round.id if open_round else "null" }};
  const statePill = document.getElementById("statePill");
  const roundPill = document.getElementById("roundPill");
  const roundQuestion = document.getElementById("roundQuestion");
  const submitStatus = document.getElementById("submitStatus");

  async function refreshState(){
    try{
      const res = await fetch("/api/state?ts=" + Date.now(), { cache: "no-store" });
      if(!res.ok){ statePill.textContent = "error"; return; }
      const data = await res.json();

      if(data.needs_register){
        window.location.href = "/register";
        return;
      }

      const open = data.open_round;
      const newId = open ? Number(open.id) : null;

      // If the round changed (opened/closed/new id), reload cleanly.
      if(newId !== currentRoundId){
        window.location.reload();
        return;
      }

      // Same round: just update small UI bits (no touching inputs).
      if(open){
        roundPill.textContent = "#" + open.id;
        if(open.question !== undefined){
          roundQuestion.innerHTML = `<strong>#${esc(open.id)}</strong> ${esc(open.question)}`;
        }
        submitStatus.textContent = open.submitted ? "Submitted ‚úÖ (you can still edit)" : "Not submitted yet";
      }else{
        roundPill.textContent = "none";
      }

      statePill.textContent = "live";
    }catch(e){
      statePill.textContent = "offline";
    }
  }

  refreshState();
  setInterval(refreshState, 3000);
</script>

{% endblock %}
