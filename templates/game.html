{% extends "base.html" %}
{% block content %}

<style>
  .game-grid{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:16px;
    align-items:start;
  }
  @media (max-width: 900px){
    .game-grid{ grid-template-columns: 1fr; }
  }

  .delta.up   { color: #30d158; font-weight: 700; }
  .delta.down { color: #ff453a; font-weight: 700; }
  .delta.same { color: inherit; opacity: 0.9; }

  .rotate-hint{
    display:none;
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.82);
    color:#fff;
    z-index:9999;
    padding:24px;
    text-align:center;
  }
  .rotate-hint .box{
    max-width:520px;
    margin:12vh auto 0;
    padding:18px;
    border-radius:14px;
    background:rgba(255,255,255,0.08);
  }
  .rotate-hint .box h3{ margin:0 0 10px 0; }
  .rotate-hint .box p{ margin:0; opacity:0.95; }
  .rotate-hint .box button{
    margin-top:14px;
    padding:10px 14px;
    border-radius:10px;
    border:0;
    cursor:pointer;
  }
</style>

<!-- Optional "force landscape" feel -->
<div class="rotate-hint" id="rotateHint">
  <div class="box">
    <h3>Rotate to landscape</h3>
    <p>For the best view (Guess + Standings side-by-side), rotate your device.</p>
    <button onclick="document.getElementById('rotateHint').style.display='none'">Continue anyway</button>
  </div>
</div>

<div class="game-grid">

  <!-- LEFT: Guess frame -->
  <div class="card">
    <h2>Play</h2>
    <p class="muted">
      Player: <strong>{{ player.name }}</strong> · Difficulty: <strong>{{ difficulty }}</strong>
    </p>

    {% if request.args.get("err") == "enter_one" %}
      <p class="err">Please enter at least one field (song, artist, or year).</p>
    {% endif %}

    {% if open_round %}
      <h3>Open round</h3>
      <p><strong>#{{ open_round.id }}</strong> {{ open_round.question or "" }}</p>

      <form method="post" action="{{ url_for('submit') }}">
        <label>Song</label>
        <input name="guess_song" value="{{ my_guess.guess_song if my_guess else '' }}" placeholder="Your guess">

        <label>Artist</label>
        <input name="guess_artist" value="{{ my_guess.guess_artist if my_guess else '' }}" placeholder="Your guess">

        <label>Year</label>
        <input name="guess_year" value="{{ my_guess.guess_year if my_guess else '' }}" placeholder="e.g. 1976">

        <button class="btn" type="submit">
          {% if my_guess %}Update guess{% else %}Submit guess{% endif %}
        </button>

        {% if my_guess %}
          <p class="muted" style="margin-top:10px;">
            Submitted ✅ (you can still edit while the round is open)
          </p>
        {% endif %}
      </form>
    {% else %}
      <p class="muted">No open round yet. Wait for the admin to start one.</p>
    {% endif %}
  </div>

  <!-- RIGHT: Standings frame -->
  <div class="card">
    <h2>Standings</h2>
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>Player</th>
          <th>Pts</th>
          <th>Δ</th>
        </tr>
      </thead>
      <tbody>
        {% for s in standings %}
          <tr>
            <td>{{ s.rank }}</td>
            <td>{{ s.player }}</td>
            <td><strong>{{ s.points }}</strong></td>
            <td>
              {% if s.delta > 0 %}
                <span class="delta up">+{{ s.delta }}</span>
              {% elif s.delta < 0 %}
                <span class="delta down">{{ s.delta }}</span>
              {% else %}
                <span class="delta same">0</span>
              {% endif %}
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>

    <p class="muted" style="margin-top:10px;">
      Refresh this page to update standings.
    </p>
  </div>

</div>

<!-- BELOW: last round results (optional, full width) -->
{% if last_closed %}
  <div class="card" style="margin-top:16px;">
    <h2>Last round results</h2>
    <p class="muted">
      <strong>#{{ last_closed.id }}</strong> {{ last_closed.question or "" }}
    </p>

    {% if correct %}
      <p>
        <strong>Correct:</strong>
        {{ correct.song }} · {{ correct.artist }} · {{ correct.year }}
      </p>
    {% endif %}

    <table>
      <thead>
        <tr>
          <th>Player</th>
          <th>Song</th>
          <th>Artist</th>
          <th>Year</th>
          <th>Song P</th>
          <th>Artist P</th>
          <th>Year P</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody>
        {% for r in last_results %}
          <tr>
            <td>{{ r.player }}</td>
            <td>{{ r.guess_song or '' }}</td>
            <td>{{ r.guess_artist or '' }}</td>
            <td>{{ r.guess_year if r.guess_year is not none else '' }}</td>
            <td>{{ r.points_song }}</td>
            <td>{{ r.points_artist }}</td>
            <td>{{ r.points_year }}</td>
            <td><strong>{{ r.total_points }}</strong></td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
{% endif %}

<script>
  // Optional: show the rotate hint only in portrait, but allow dismiss.
  const hint = document.getElementById("rotateHint");
  function updateHint(){
    const portrait = window.matchMedia && window.matchMedia("(orientation: portrait)").matches;
    // show hint if portrait (you can set to always block by removing the dismiss button)
    hint.style.display = portrait ? "block" : "none";
  }
  updateHint();
  window.addEventListener("resize", updateHint);
</script>

{% endblock %}
