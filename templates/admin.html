{% extends "base.html" %}
{% block content %}

{% set r = open_round or current_round %}

<div class="card">
  <h2>Admin</h2>
  {% if msg %}<p class="ok">{{ msg }}</p>{% endif %}
  {% if err %}<p class="err">{{ err }}</p>{% endif %}
</div>

<div class="grid" id="adminGrid" style="grid-template-columns:1fr; gap:14px;">

  <!-- LEFT: Round control -->
  <div class="card">
    <h3>Round</h3>

    {% if r %}
      <p class="muted">Open round: <strong>#{{ r.id }}</strong></p>
      <p style="font-size:1.05rem;">{{ r.question or "" }}</p>

      <form method="post" style="margin-top:10px;">
        <input type="hidden" name="action" value="set_answers">

        <label>Correct song</label>
        <input type="text" name="correct_song" value="{{ r.correct_song or '' }}">

        <label>Correct artist</label>
        <input type="text" name="correct_artist" value="{{ r.correct_artist or '' }}">

        <label>Correct year</label>
        <input type="text" name="correct_year" value="{{ r.correct_year or '' }}" inputmode="numeric">

        <button class="btn" type="submit" style="margin-top:10px;">Update correct answers</button>
      </form>

      <form method="post" style="margin-top:10px;" onsubmit="return confirm('Close this round and score it?');">
        <input type="hidden" name="action" value="close_round">
        <button class="btn secondary" type="submit">Close & score</button>
      </form>
    {% else %}
      <p class="muted">No active rounds (this will auto-update).</p>
    {% endif %}

    <hr style="border:0; border-top:1px solid var(--line); margin:14px 0;">

    <h3>Create round (manual)</h3>
    <form method="post">
      <input type="hidden" name="action" value="create_round">
      <label>Question</label>
      <textarea name="question" rows="2" placeholder='e.g. "Song #3"'></textarea>
      <button class="btn" type="submit" style="margin-top:10px;">Create + open</button>
    </form>

    <hr style="border:0; border-top:1px solid var(--line); margin:14px 0;">

    <h3>Reset</h3>
    <form method="post" onsubmit="return confirm('Reset rounds/guesses/history? Players kept.');">
      <input type="hidden" name="action" value="reset_game">
      <button class="btn danger" type="submit">Reset game</button>
    </form>
  </div>

  <!-- RIGHT: Live guesses -->
  <div class="card">
    <h3>Live submissions</h3>
    <div class="muted" id="liveMeta">Auto refresh every 4s</div>
    <div class="muted" id="liveRound" style="margin-top:8px;"></div>

    <table style="margin-top:10px;">
      <thead>
        <tr>
          <th>Player</th>
          <th>Song</th>
          <th>Artist</th>
          <th>Year</th>
          <th style="width:160px;">Updated</th>
        </tr>
      </thead>
      <tbody id="liveBody"></tbody>
    </table>
  </div>

</div>

<script>
  // 2 columns on wide screens
  const mq = window.matchMedia("(min-width: 1000px)");
  function applyColumns() {
    const grid = document.getElementById("adminGrid");
    if (!grid) return;
    grid.style.gridTemplateColumns = mq.matches ? "1fr 1fr" : "1fr";
  }
  mq.addEventListener("change", applyColumns);
  applyColumns();

  const LIVE_MS = 4000; // >= 3 seconds

  function esc(s){
    return String(s ?? "").replace(/[&<>"']/g, c => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[c]));
  }

  async function refreshLive() {
    try {
      const res = await fetch("/api/admin/open_round_guesses?ts=" + Date.now(), {
        cache: "no-store",
        credentials: "same-origin"
      });

      if (res.status === 403) {
        window.location.href = "/admin/login";
        return;
      }

      const data = await res.json();
      if (!data || !data.ok) return;

      // Your endpoint might return either:
      //  A) {has_open_round:true, round:{id,question}, rows:[...]}
      //  B) {has_open_round:true, round_id:..., rows:[...]}
      const has = !!data.has_open_round;
      const roundObj = data.round || (data.round_id ? { id: data.round_id, question: data.question || "" } : null);

      const liveRound = document.getElementById("liveRound");
      const tbody = document.getElementById("liveBody");

      if (!has || !roundObj) {
        if (liveRound) liveRound.textContent = "No open round.";
        if (tbody) tbody.innerHTML = "";
        return;
      }

      if (liveRound) {
        liveRound.textContent = `Round #${roundObj.id}: ${roundObj.question || ""} (submissions: ${(data.rows||[]).length})`;
      }

      if (tbody) {
        tbody.innerHTML = "";
        for (const row of (data.rows || [])) {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${esc(row.player)}</td>
            <td>${esc(row.guess_song)}</td>
            <td>${esc(row.guess_artist)}</td>
            <td>${esc(row.guess_year)}</td>
            <td class="muted">${esc(row.updated_at)}</td>
          `;
          tbody.appendChild(tr);
        }
      }
    } catch(e) {}
  }

  refreshLive();
  setInterval(refreshLive, LIVE_MS);
</script>

{% endblock %}
