{% extends "base.html" %}

{% block content %}

{% if not is_admin %}
  <div class="card">
    <h2>Hitster – Admin login</h2>
    {% if error %}
      <p style="color:#ff5252;">{{ error }}</p>
    {% endif %}
    <form method="post">
      <input type="hidden" name="action" value="login">
      <label>Admin password</label>
      <input type="password" name="password" placeholder="Password">
      <button type="submit" class="btn">Login</button>
    </form>
  </div>
{% else %}

  <div class="card">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <h2>Hitster – Admin panel</h2>
      <form method="post" style="margin:0;">
        <input type="hidden" name="action" value="logout_admin">
        <button type="submit" class="btn secondary">Logout</button>
      </form>
    </div>

    {% if error %}
      <p style="color:#ff5252;">{{ error }}</p>
    {% endif %}
  </div>

  <!-- Scoring mode selection -->
  <div class="card">
  <h3>Scoring mode</h3>
  <p>Current mode: <strong>{{ difficulty|capitalize }}</strong></p>

  {% if not difficulty_locked %}
    <form method="post">
      <input type="hidden" name="action" value="set_difficulty">

      <label>
        <input type="radio" name="difficulty" value="easy"
               {% if difficulty == 'easy' %}checked{% endif %}>
        Easy – 5/4/3, closest=1, no negatives
      </label><br>

      <label>
        <input type="radio" name="difficulty" value="hard"
               {% if difficulty == 'hard' %}checked{% endif %}>
        Hard – 10/8/6/4/2, big miss = -4
      </label><br>

      <label>
        <input type="radio" name="difficulty" value="extreme"
               {% if difficulty == 'extreme' %}checked{% endif %}>
        Extreme – only exact year = 10, diff&gt;10 = -5
      </label><br><br>

      <button type="submit" class="btn">Save scoring mode</button>
    </form>
  {% else %}
    <p>
      Difficulty is <strong>locked</strong> for this game.<br>
      To change it, reset the game and set difficulty again before creating the first round.
    </p>
  {% endif %}
</div>

  <!-- Create/open round -->
  <div class="card">
    <h3>Create &amp; open a new round</h3>
    <form method="post">
      <input type="hidden" name="action" value="create_round">

      <label>Question (e.g. "Song #3")</label>
      <textarea name="question" rows="2" placeholder="Text players see"></textarea>

      <label>Correct song (optional now)</label>
      <input type="text" name="correct_song" placeholder="Exact song title">

      <label>Correct artist (optional now)</label>
      <input type="text" name="correct_artist" placeholder="Exact artist name">

      <label>Correct year (optional now)</label>
      <input type="text" name="correct_year" placeholder="e.g. 1976">

      <button type="submit" class="btn">Create + open round</button>
    </form>
  </div>

  <!-- Current round -->
  <div class="card">
    <h3>Current open round</h3>
    {% if current_round %}
      <p><strong>ID:</strong> {{ current_round['id'] }}</p>
      <p><strong>Question:</strong> {{ current_round['question'] }}</p>

      <form method="post" style="margin-top:8px; margin-bottom: 8px;">
        <input type="hidden" name="action" value="set_answers">

        <label>Correct song</label>
        <input type="text" name="correct_song" value="{{ current_round['correct_song'] or '' }}">

        <label>Correct artist</label>
        <input type="text" name="correct_artist" value="{{ current_round['correct_artist'] or '' }}">

        <label>Correct year</label>
        <input type="text" name="correct_year" value="{{ current_round['correct_year'] or '' }}">

        <button type="submit" class="btn">Update correct answers</button>
      </form>

      <form method="post" style="margin-top:8px;">
        <input type="hidden" name="action" value="close_round">
        <button type="submit" class="btn secondary">Close &amp; score this round</button>
      </form>
    {% else %}
      <p>No open round.</p>
    {% endif %}
  </div>

  <!-- Players and their answers in current round -->
  <div class="card">
    <h3>Players in current round</h3>
    {% if current_round and current_round_players %}
      <table>
        <thead>
          <tr>
            <th>Player</th>
            <th>Song</th>
            <th>Artist</th>
            <th>Year</th>
          </tr>
        </thead>
        <tbody>
          {% for p in current_round_players %}
            <tr>
              <td>{{ p['name'] }}</td>
              <td>{{ p['answer_song'] or '' }}</td>
              <td>{{ p['answer_artist'] or '' }}</td>
              <td>{{ p['answer_year'] or '' }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% elif current_round %}
      <p>No answers yet.</p>
    {% else %}
      <p>No open round.</p>
    {% endif %}
  </div>

  <!-- Recent rounds -->
  <div class="card">
    <h3>Recent rounds</h3>
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>Status</th>
          <th>Question</th>
          <th>Song</th>
          <th>Artist</th>
          <th>Year</th>
          <th>Created</th>
        </tr>
      </thead>
      <tbody>
        {% for r in rounds %}
          <tr>
            <td>{{ r['id'] }}</td>
            <td>{{ r['status'] }}</td>
            <td>{{ r['question'] }}</td>
            <td>{{ r['correct_song'] }}</td>
            <td>{{ r['correct_artist'] }}</td>
            <td>{{ r['correct_year'] }}</td>
            <td>{{ r['created_at'] }}</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Reset entire game -->
  <div class="card">
    <h3>Reset game</h3>
    <p>This will delete all rounds, guesses, and standings snapshots, but keep the player list.</p>
    <form method="post" onsubmit="return confirm('Are you sure you want to reset the game?');">
      <input type="hidden" name="action" value="reset_game">
      <button type="submit" class="btn danger">Reset game</button>
    </form>
  </div>

{% endif %}

{% endblock %}
