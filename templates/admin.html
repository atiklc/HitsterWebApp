{% extends "base.html" %}
{% block content %}

<div class="card">
  <h2>Admin</h2>
  {% if msg %}<p class="ok">{{ msg }}</p>{% endif %}
  {% if err %}<p class="err">{{ err }}</p>{% endif %}

  <div class="muted">
    Status: <span class="pill">{{ status }}</span>
    {% if status == "ended" %}Ended at: <span class="pill">{{ ended_at }}</span>{% endif %}
    Auto rounds: <span class="pill">{{ "ON" if auto_rounds else "OFF" }}</span>
    {% if next_round_at %}Next round at: <span class="pill">{{ next_round_at }}</span>{% endif %}
  </div>
</div>

<div class="grid" style="grid-template-columns:1fr; gap:14px;" id="adminGrid">

  <!-- Left: controls -->
  <div class="card">
    <h3>Game control</h3>

    <div class="row" style="margin-top:8px;">
      <form method="post">
        <input type="hidden" name="action" value="start_game">
        <button class="btn" type="submit">Start game (auto rounds)</button>
      </form>

      <form method="post">
        <input type="hidden" name="action" value="stop_auto">
        <button class="btn secondary" type="submit">Stop auto</button>
      </form>

      <form method="post" onsubmit="return confirm('End game? This locks submissions.');">
        <input type="hidden" name="action" value="end_game">
        <button class="btn danger" type="submit">End game</button>
      </form>
    </div>

    <hr style="border:0; border-top:1px solid var(--line); margin:14px 0;">

    <h3>Difficulty (only before first round)</h3>
    <form method="post">
      <input type="hidden" name="action" value="set_difficulty">
      <select name="difficulty" {% if locked %}disabled{% endif %}>
        <option value="easy" {% if difficulty=='easy' %}selected{% endif %}>Easy</option>
        <option value="hard" {% if difficulty=='hard' %}selected{% endif %}>Hard</option>
        <option value="extreme" {% if difficulty=='extreme' %}selected{% endif %}>Extreme</option>
      </select>
      <div class="row" style="margin-top:10px;">
        <button class="btn" type="submit" {% if locked %}disabled{% endif %}>Save</button>
        {% if locked %}<span class="muted">Locked after first round.</span>{% endif %}
      </div>
    </form>

    <label>Auto question prefix</label>
    <form method="post">
      <input type="hidden" name="action" value="set_prefix">
      <input name="question_prefix" value="{{ question_prefix }}">
      <button class="btn" type="submit" style="margin-top:10px;">Save prefix</button>
    </form>

    <hr style="border:0; border-top:1px solid var(--line); margin:14px 0;">

    <h3>Open round</h3>
    {% if open_round %}
      <p class="muted">#{{ open_round.id }}</p>
      <p style="font-size:1.05rem;">{{ open_round.question }}</p>

      <form method="post" style="margin-top:10px;">
        <input type="hidden" name="action" value="set_answers">
        <label>Correct song</label>
        <input name="correct_song" value="{{ open_round.correct_song or '' }}">
        <label>Correct artist</label>
        <input name="correct_artist" value="{{ open_round.correct_artist or '' }}">
        <label>Correct year</label>
        <input name="correct_year" value="{{ open_round.correct_year or '' }}" inputmode="numeric">
        <button class="btn" type="submit" style="margin-top:10px;">Update correct answers</button>
      </form>

      <form method="post" style="margin-top:10px;" onsubmit="return confirm('Close this round and score it?');">
        <input type="hidden" name="action" value="close_round">
        <button class="btn secondary" type="submit">Close & score (next round in 5s)</button>
      </form>
    {% else %}
      <p class="muted">No open round.</p>
    {% endif %}

    <hr style="border:0; border-top:1px solid var(--line); margin:14px 0;">

    <h3>Reset</h3>
    <form method="post" onsubmit="return confirm('Reset rounds/guesses/history? Players kept.');">
      <input type="hidden" name="action" value="reset_game">
      <button class="btn danger" type="submit">Reset game</button>
    </form>
  </div>

  <!-- Right: live guesses -->
  <div class="card">
    <h3>Live submissions</h3>
    <div class="muted" id="liveMeta">Auto refresh every 4s</div>

    <div id="liveRound" class="muted" style="margin-top:8px;"></div>

    <table style="margin-top:10px;">
      <thead>
        <tr>
          <th>Player</th>
          <th>Song</th>
          <th>Artist</th>
          <th>Year</th>
          <th style="width:160px;">Updated</th>
        </tr>
      </thead>
      <tbody id="liveBody">
        {% for r in live_rows %}
          <tr>
            <td>{{ r.player }}</td>
            <td>{{ r.guess_song or '' }}</td>
            <td>{{ r.guess_artist or '' }}</td>
            <td>{{ r.guess_year if r.guess_year is not none else '' }}</td>
            <td class="muted">{{ r.updated_at }}</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

</div>

<script>
  const mq = window.matchMedia("(min-width: 1000px)");
  function applyColumns() {
    const grid = document.getElementById("adminGrid");
    if (!grid) return;
    grid.style.gridTemplateColumns = mq.matches ? "1fr 1fr" : "1fr";
  }
  mq.addEventListener("change", applyColumns);
  applyColumns();

  // refresh NOT faster than 3s
  const LIVE_MS = 4000;
  let lastRoundId = {{ open_round.id if open_round else "null" }};

  function escapeHtml(s) {
    return String(s).replace(/[&<>"']/g, (c) => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[c]));
  }

  async function refreshLive() {
    try {
      const r = await fetch("/api/admin/open_round_guesses?ts=" + Date.now(), { cache: "no-store" });
      const data = await r.json();
      if (!data || !data.ok) return;

      const liveRound = document.getElementById("liveRound");
      const tbody = document.getElementById("liveBody");
      if (!tbody) return;

      if (!data.has_open_round) {
        if (liveRound) liveRound.textContent = "No open round.";
        tbody.innerHTML = "";
        lastRoundId = null;
        return;
      }

      const rid = data.round.id;
      if (liveRound) liveRound.textContent = `Round #${rid}: ${data.round.question} (submissions: ${data.rows.length})`;

      // If round id changed, just rebuild list
      lastRoundId = rid;

      tbody.innerHTML = "";
      for (const row of data.rows) {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${escapeHtml(row.player)}</td>
          <td>${escapeHtml(row.guess_song || "")}</td>
          <td>${escapeHtml(row.guess_artist || "")}</td>
          <td>${escapeHtml(row.guess_year || "")}</td>
          <td class="muted">${escapeHtml(row.updated_at || "")}</td>
        `;
        tbody.appendChild(tr);
      }
    } catch(e) {}
  }

  refreshLive();
  setInterval(refreshLive, LIVE_MS);
</script>

{% endblock %}
